<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>Meu Player Pro</title>
    <meta name="theme-color" content="#121212"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Meu Player">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/000000/music.png">
    <link rel="icon" href="https://img.icons8.com/fluency/96/000000/music.png" type="image/png">

    <!-- Manifesto do PWA com start_url corrigido -->
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAic2hvcnRfbmFtZSI6ICJQbGF5ZXIiLA0KICAibmFtZSI6ICJNZXUgUGxheWVyIGRlIE3DunNpY2EiLA0KICAiaWNvbnMiOiBbDQogICAgew0KICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvNDgvMDAwMDAwL211c2ljLnBuZyIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjQ4eDQ4Ig0KICAgIH0sDQogICAgew0KICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvOTYvMDAwMDAwL211c2ljLnBuZyIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjk2eDk2Ig0KICAgIH0NCiAgXSwNCiAgInN0YXJ0X3VybCI6ICIvIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsDQogICJ0aGVtZV9jb2xvciI6ICIjMTIxMjEyIiwNCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiINCn0=">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    
    <!-- SDKs do Firebase (v9 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --primary-color: #1DB954; --background-color: #121212; --surface-color: #1e1e1e;
            --text-color: #ffffff; --text-secondary-color: #b3b3b3; --player-bar-height: 90px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--background-color);
            color: var(--text-color); display: flex; flex-direction: column; user-select: none;
        }
        .main-view {
            flex-grow: 1; overflow-y: auto;
            padding: 20px 20px calc(var(--player-bar-height) + 20px) 20px;
        }
        .hidden { display: none !important; }
        
        /* Estilos Gerais */
        .section-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .btn-primary {
            padding: 10px 20px; background-color: var(--primary-color); color: var(--text-color);
            border: none; border-radius: 50px; cursor: pointer; font-weight: 500;
            font-size: 14px; transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.95); }

        /* Tela de Carregamento/Setup */
        #setup-view, #loading-view {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center;
        }
        #setup-view p { color: var(--text-secondary-color); margin-bottom: 30px; max-width: 300px; }
        
        /* Anima√ß√£o de Carregamento */
        .loading-animation { display: flex; align-items: flex-end; height: 50px; margin-bottom: 20px; }
        .bar { width: 8px; margin: 0 4px; background-color: var(--primary-color); animation: pulse 1.2s infinite ease-in-out; }
        .bar:nth-child(2) { animation-delay: 0.2s; }
        .bar:nth-child(3) { animation-delay: 0.4s; }
        .bar:nth-child(4) { animation-delay: 0.6s; }
        @keyframes pulse { 0%, 100% { height: 10px; } 50% { height: 50px; } }
        
        #loading-message { font-size: 14px; color: var(--text-secondary-color); height: 2em; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 90%; }
        #loading-counter { font-weight: 500; }

        /* Navega√ß√£o Principal (Abas) */
        #main-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--surface-color); }
        .nav-tab { padding: 10px 0; cursor: pointer; color: var(--text-secondary-color); font-weight: 500; }
        .nav-tab.active { color: var(--text-color); border-bottom: 2px solid var(--primary-color); }

        /* Grade de √Ålbuns e Playlists */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px;
        }
        .card {
            cursor: pointer; background-color: var(--surface-color); padding: 15px;
            border-radius: 10px; transition: background-color 0.2s;
        }
        .card:hover { background-color: #282828; }
        .card-art {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 5px; object-fit: cover;
            background-color: #333; margin-bottom: 10px; display: flex; justify-content: center;
            align-items: center; font-size: 48px; color: var(--text-secondary-color);
        }
        .card-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-subtitle { font-size: 14px; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Lista de M√∫sicas */
        #tracklist-header { display: flex; align-items: center; margin-bottom: 20px; }
        #back-btn { background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; margin-right: 15px; }
        #header-art { width: 50px; height: 50px; border-radius: 5px; margin-right: 15px; }
        #header-title { font-size: 18px; font-weight: 700; }
        
        #tracklist { list-style: none; }
        .track-item { display: flex; align-items: center; padding: 10px 5px; border-radius: 5px; position: relative; }
        .track-item-clickable { cursor: pointer; }
        .track-item-clickable:hover { background-color: #282828; }
        .track-item.active .track-title { color: var(--primary-color); }
        .track-info { flex-grow: 1; overflow: hidden; }
        .track-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .track-artist { font-size: 12px; color: var(--text-secondary-color); }
        .options-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: 20px; padding: 5px; }

        /* Player Bar */
        #player-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-bar-height);
            background-color: #181818; border-top: 1px solid #282828; padding: 10px 20px;
            display: flex; align-items: center; gap: 15px;
        }
        #player-art { width: 50px; height: 50px; border-radius: 5px; }
        #player-info { flex-grow: 1; overflow: hidden; }
        #player-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-artist { font-size: 12px; color: var(--text-secondary-color); }
        #player-controls-center { display: flex; flex-direction: column; align-items: center; }
        #player-buttons { display: flex; align-items: center; }
        .control-btn { background: none; border: none; color: var(--text-color); font-size: 22px; cursor: pointer; margin: 0 10px; }
        #play-pause-btn { font-size: 40px; }
        #progress-container { display: flex; align-items: center; gap: 8px; width: 100%; max-width: 400px; }
        #progress-bar { width: 100%; height: 4px; background: #535353; border-radius: 2px; -webkit-appearance: none; appearance: none; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-color); border-radius: 50%; }
        .time-label { font-size: 12px; color: var(--text-secondary-color); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--surface-color); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #535353; background: #333; color: var(--text-color); margin-bottom: 15px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        #modal-playlist-list li { padding: 10px; cursor: pointer; border-radius: 5px; }
        #modal-playlist-list li:hover { background-color: #282828; }
    </style>
</head>
<body>

    <audio id="audio-player"></audio>

    <div id="setup-view" class="main-view">
        <p id="setup-message">Conectando ao servidor...</p>
        <button id="setup-btn" class="btn-primary hidden">Selecionar Pasta de M√∫sicas</button>
    </div>

    <div id="loading-view" class="main-view hidden">
        <div class="loading-animation">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <p id="loading-message">Procurando m√∫sicas...</p>
        <p id="loading-counter"></p>
    </div>

    <div id="library-view" class="main-view hidden">
        <nav id="main-nav">
            <span class="nav-tab active" data-view="albums-view">√Ålbuns</span>
            <span class="nav-tab" data-view="playlists-view">Playlists</span>
        </nav>
        
        <div id="albums-view">
            <div id="album-grid" class="grid-container"></div>
        </div>
        
        <div id="playlists-view" class="hidden">
            <button id="new-playlist-btn" class="btn-primary" style="margin-bottom: 20px;">+ Nova Playlist</button>
            <div id="playlist-grid" class="grid-container"></div>
        </div>
    </div>

    <div id="tracklist-view" class="main-view hidden">
        <div id="tracklist-header">
            <button id="back-btn">&lt;</button>
            <img id="header-art" src="https://placehold.co/100x100/333/333?text=." alt="Capa">
            <div>
                <div id="header-title">T√≠tulo</div>
            </div>
        </div>
        <ul id="tracklist"></ul>
    </div>

    <div id="player-bar" class="hidden">
        <img id="player-art" src="https://placehold.co/100x100/333/333?text=.">
        <div id="player-info">
            <div id="player-title">Nenhuma m√∫sica</div>
            <div id="player-artist">tocando</div>
        </div>
        <div id="player-controls-center">
            <div id="player-buttons">
                <button class="control-btn" id="prev-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="control-btn" id="play-pause-btn">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="control-btn" id="next-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"/></svg>
                </button>
            </div>
            <div id="progress-container">
                <span id="current-time" class="time-label">0:00</span>
                <input type="range" id="progress-bar" value="0" step="1">
                <span id="total-time" class="time-label">0:00</span>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="playlist-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Nova Playlist</h3>
            <input type="text" id="playlist-name-input" placeholder="Nome da Playlist">
            <div class="modal-actions">
                <button id="cancel-playlist-btn">Cancelar</button>
                <button id="create-playlist-btn" class="btn-primary">Criar</button>
            </div>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="modal-overlay hidden">
         <div class="modal-content">
            <h3>Adicionar √† Playlist</h3>
            <ul id="modal-playlist-list" style="list-style:none; margin-bottom: 20px;"></ul>
            <div class="modal-actions">
                <button id="cancel-add-btn">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO DO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyCdIsMkDsxDUy4FD2TcZ4IiGnB2mpj6Tb8",
                authDomain: "mp3musica-ff3e3.firebaseapp.com",
                projectId: "mp3musica-ff3e3",
                storageBucket: "mp3musica-ff3e3.firebasestorage.app",
                messagingSenderId: "555438657869",
                appId: "1:555438657869:web:b40f7c0509311bf8642704"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let userId = null;
            let userPlaylists = [];
            let favoritesPlaylist = null;

            // --- ELEMENTOS DA UI ---
            const setupView = document.getElementById('setup-view');
            const loadingView = document.getElementById('loading-view');
            const libraryView = document.getElementById('library-view');
            const tracklistView = document.getElementById('tracklist-view');
            const playerBar = document.getElementById('player-bar');
            const mainNavTabs = document.querySelectorAll('.nav-tab');
            const albumsView = document.getElementById('albums-view');
            const playlistsView = document.getElementById('playlists-view');
            const albumGrid = document.getElementById('album-grid');
            const playlistGrid = document.getElementById('playlist-grid');
            const backBtn = document.getElementById('back-btn');
            const tracklistElement = document.getElementById('tracklist');
            const newPlaylistBtn = document.getElementById('new-playlist-btn');
            const playlistModal = document.getElementById('playlist-modal');
            const cancelPlaylistBtn = document.getElementById('cancel-playlist-btn');
            const createPlaylistBtn = document.getElementById('create-playlist-btn');
            const playlistNameInput = document.getElementById('playlist-name-input');
            const addToPlaylistModal = document.getElementById('add-to-playlist-modal');
            const modalPlaylistList = document.getElementById('modal-playlist-list');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeElement = document.getElementById('current-time');
            const totalTimeElement = document.getElementById('total-time');
            const playerArt = document.getElementById('player-art');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            
            const playIcon = `<svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
            const pauseIcon = `<svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;

            // --- ESTADO DO APP ---
            let allTracks = new Map();
            let albums = new Map();
            let currentPlaylist = [];
            let currentTrackIndex = -1;
            let isPlaying = false;
            let trackToAddToPlaylist = null;
            let currentView = 'setup';

            // --- INICIALIZA√á√ÉO DO APP ---
            async function init() {
                try {
                    await auth.signInAnonymously();
                    userId = auth.currentUser.uid;
                    await loadPlaylistsFromFirebase();
                    
                    const dirHandle = await getDirectoryHandleFromDB();
                    if (dirHandle) {
                        if (await verifyPermission(dirHandle)) {
                            showView('loading');
                            await scanAndProcessDirectory(dirHandle);
                            renderAll();
                            showView('library');
                        } else {
                            throw new Error('Permiss√£o negada.');
                        }
                    } else {
                         showSetupButton('Selecione sua pasta de m√∫sicas para come√ßar.');
                    }
                } catch (error) {
                    console.error("Erro na inicializa√ß√£o:", error);
                    const errorMessage = error.code === 'auth/configuration-not-found'
                        ? 'Erro: Ative o Login An√¥nimo no seu painel do Firebase.'
                        : 'Clique para selecionar sua pasta de m√∫sicas.';
                    showSetupButton(errorMessage);
                }
            }
            
            function showSetupButton(message) {
                const p = setupView.querySelector('p');
                const btn = setupView.querySelector('button');
                p.textContent = message;
                btn.classList.remove('hidden');
                btn.onclick = selectAndScanDirectory;
                showView('setup');
            }
            
            async function selectAndScanDirectory() {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    showView('loading'); // Mostra a tela de carregamento IMEDIATAMENTE
                    await saveDirectoryHandleToDB(dirHandle);
                    await scanAndProcessDirectory(dirHandle);
                    renderAll();
                    showView('library');
                } catch (err) {
                    console.error("Erro ao selecionar pasta:", err);
                    alert("Voc√™ precisa dar permiss√£o √† pasta para o app funcionar.");
                    showSetupButton('Clique para selecionar sua pasta de m√∫sicas.');
                }
            }

            // --- L√ìGICA DE ARQUIVOS E INDEXEDDB ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('MusicPlayerDB', 1);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        db.createObjectStore('fileStore');
                    };
                    request.onsuccess = event => resolve(event.target.result);
                    request.onerror = event => reject(event.target.error);
                });
            }

            async function saveDirectoryHandleToDB(dirHandle) {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('fileStore', 'readwrite');
                    tx.objectStore('fileStore').put(dirHandle, 'dirHandle');
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async function getDirectoryHandleFromDB() {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('fileStore', 'readonly');
                    const request = tx.objectStore('fileStore').get('dirHandle');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async function verifyPermission(dirHandle) {
                if (!dirHandle) return false;
                const options = { mode: 'read' };
                if (await dirHandle.queryPermission(options) === 'granted') return true;
                if (await dirHandle.requestPermission(options) === 'granted') return true;
                return false;
            }

            async function scanAndProcessDirectory(dirHandle) {
                allTracks.clear();
                albums.clear();
                
                let processedCount = 0;
                const loadingMessage = document.getElementById('loading-message');
                const loadingCounter = document.getElementById('loading-counter');

                async function scan(dir) {
                    for await (const entry of dir.values()) {
                        if (entry.kind === 'file' && entry.name.match(/\.(mp3|m4a|flac|wav)$/i)) {
                            processedCount++;
                            loadingCounter.textContent = `${processedCount} m√∫sicas encontradas`;
                            loadingMessage.textContent = entry.name;
                            
                            const file = await entry.getFile();
                            await processFile(file);

                        } else if (entry.kind === 'directory') {
                            await scan(entry);
                        }
                    }
                }

                await scan(dirHandle);
            }
            
            function generateTrackId(tags, file) {
                const key = `${tags.title}-${tags.artist}-${tags.album}-${file.size}`;
                let hash = 0;
                for (let i = 0; i < key.length; i++) {
                    const char = key.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; 
                }
                return 'track_' + Math.abs(hash);
            }

            function processFile(file) {
                return new Promise((resolve) => {
                    window.jsmediatags.read(file, {
                        onSuccess: function(tag) {
                            const tags = tag.tags;
                            const trackId = generateTrackId(tags, file);
                            
                            let imageSrc = 'https://placehold.co/300x300/333/FFFFFF?text=?';
                            if (tags.picture) {
                                const { data, format } = tags.picture;
                                let base64String = "";
                                for (let i = 0; i < data.length; i++) {
                                    base64String += String.fromCharCode(data[i]);
                                }
                                imageSrc = `data:${format};base64,${window.btoa(base64String)}`;
                            }
                            
                            const trackData = {
                                id: trackId,
                                title: tags.title || file.name.replace(/\.[^/.]+$/, ""),
                                artist: tags.artist || 'Artista Desconhecido',
                                album: tags.album || '√Ålbum Desconhecido',
                                art: imageSrc,
                                file: file
                            };
                            allTracks.set(trackId, trackData);

                            const albumName = trackData.album;
                            if (!albums.has(albumName)) {
                                albums.set(albumName, { artist: trackData.artist, art: trackData.art, tracks: [] });
                            }
                            albums.get(albumName).tracks.push(trackId);
                            resolve();
                        },
                        onError: function(error) {
                            console.log('Erro ao ler tags:', file.name, error);
                            resolve();
                        }
                    });
                });
            }

            // --- L√ìGICA DO FIREBASE ---
            async function loadPlaylistsFromFirebase() {
                const snapshot = await db.collection('users').doc(userId).collection('playlists').get();
                userPlaylists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                favoritesPlaylist = userPlaylists.find(p => p.name === 'Favoritas');
                if (!favoritesPlaylist) {
                    favoritesPlaylist = await savePlaylistToFirebase('Favoritas');
                }
            }

            async function savePlaylistToFirebase(name, tracks = []) {
                const playlistData = { name, tracks };
                const docRef = await db.collection('users').doc(userId).collection('playlists').add(playlistData);
                const newPlaylist = { id: docRef.id, ...playlistData };
                userPlaylists.push(newPlaylist);
                return newPlaylist;
            }
            
            async function updatePlaylistInFirebase(playlistId, tracks) {
                 await db.collection('users').doc(userId).collection('playlists').doc(playlistId).update({ tracks });
                 const playlist = userPlaylists.find(p => p.id === playlistId);
                 if(playlist) playlist.tracks = tracks;
            }

            // --- RENDERIZA√á√ÉO E L√ìGICA DE UI ---
            function showView(viewName) {
                document.querySelectorAll('.main-view').forEach(v => v.classList.add('hidden'));
                const view = document.getElementById(`${viewName}-view`);
                if (view) view.classList.remove('hidden');
                
                if (viewName !== 'setup' && viewName !== 'loading') {
                    playerBar.classList.remove('hidden');
                } else {
                    playerBar.classList.add('hidden');
                }
                currentView = viewName;
            }

            function renderAll() {
                renderAlbums();
                renderPlaylists();
            }
            
            function renderAlbums() {
                albumGrid.innerHTML = '';
                const sortedAlbums = new Map([...albums.entries()].sort());
                for (const [albumName, albumData] of sortedAlbums.entries()) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img class="card-art" src="${albumData.art}" alt="${albumName}">
                        <div class="card-title">${albumName}</div>
                        <div class="card-subtitle">${albumData.artist}</div>
                    `;
                    card.onclick = () => renderTracklist({ type: 'album', name: albumName });
                    albumGrid.appendChild(card);
                }
            }

            function renderPlaylists() {
                playlistGrid.innerHTML = '';
                userPlaylists.forEach(playlist => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    const art = playlist.name === 'Favoritas' ? '‚ù§Ô∏è' : 'üéµ';
                    card.innerHTML = `
                        <div class="card-art">${art}</div>
                        <div class="card-title">${playlist.name}</div>
                        <div class="card-subtitle">${playlist.tracks.length} m√∫sicas</div>
                    `;
                    card.onclick = () => renderTracklist({ type: 'playlist', id: playlist.id });
                    playlistGrid.appendChild(card);
                });
            }
            
            function renderTracklist({ type, name, id }) {
                let headerArt, headerTitle, trackIds;
                if (type === 'album') {
                    const albumData = albums.get(name);
                    headerArt = albumData.art;
                    headerTitle = name;
                    trackIds = albumData.tracks;
                } else { // playlist
                    const playlist = userPlaylists.find(p => p.id === id);
                    headerArt = playlist.name === 'Favoritas' ? null : 'https://placehold.co/100x100/333/FFFFFF?text=üéµ';
                    headerTitle = playlist.name;
                    trackIds = playlist.tracks;
                }
                
                document.getElementById('header-art').src = headerArt || 'https://placehold.co/100x100/333/FFFFFF?text=‚ù§Ô∏è';
                document.getElementById('header-title').textContent = headerTitle;
                
                tracklistElement.innerHTML = '';
                if (trackIds.length === 0) {
                    tracklistElement.innerHTML = '<p style="color: var(--text-secondary-color); text-align: center; margin-top: 20px;">Nenhuma m√∫sica aqui.</p>';
                }
                trackIds.forEach((trackId, index) => {
                    const track = allTracks.get(trackId);
                    if (!track) return;
                    
                    const li = document.createElement('li');
                    li.className = 'track-item';
                    li.innerHTML = `
                        <div class="track-info track-item-clickable">
                            <div class="track-title">${track.title}</div>
                            <div class="track-artist">${track.artist}</div>
                        </div>
                        <button class="options-btn">‚ãÆ</button>
                    `;
                    li.querySelector('.track-item-clickable').onclick = () => {
                        currentPlaylist = trackIds;
                        loadTrack(index);
                        playTrack();
                    };
                    li.querySelector('.options-btn').onclick = (e) => {
                        e.stopPropagation();
                        openAddToPlaylistModal(trackId);
                    };
                    tracklistElement.appendChild(li);
                });
                showView('tracklist');
            }

            mainNavTabs.forEach(tab => {
                tab.onclick = () => {
                    mainNavTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    albumsView.classList.toggle('hidden', tab.dataset.view !== 'albums-view');
                    playlistsView.classList.toggle('hidden', tab.dataset.view !== 'playlists-view');
                }
            });

            backBtn.onclick = () => showView('library');

            // --- MODALS ---
            newPlaylistBtn.onclick = () => playlistModal.classList.remove('hidden');
            cancelPlaylistBtn.onclick = () => playlistModal.classList.add('hidden');
            createPlaylistBtn.onclick = async () => {
                const name = playlistNameInput.value.trim();
                if (name) {
                    await savePlaylistToFirebase(name);
                    renderPlaylists();
                    playlistNameInput.value = '';
                    playlistModal.classList.add('hidden');
                }
            };
            
            function openAddToPlaylistModal(trackId) {
                trackToAddToPlaylist = trackId;
                modalPlaylistList.innerHTML = '';
                
                const favLi = document.createElement('li');
                const isFavorite = favoritesPlaylist.tracks.includes(trackId);
                favLi.textContent = isFavorite ? '‚ù§Ô∏è Remover dos Favoritos' : '‚ù§Ô∏è Adicionar aos Favoritos';
                favLi.onclick = async () => {
                    const tracks = isFavorite 
                        ? favoritesPlaylist.tracks.filter(t => t !== trackId)
                        : [...favoritesPlaylist.tracks, trackId];
                    await updatePlaylistInFirebase(favoritesPlaylist.id, tracks);
                    addToPlaylistModal.classList.add('hidden');
                };
                modalPlaylistList.appendChild(favLi);

                userPlaylists.filter(p => p.name !== 'Favoritas').forEach(playlist => {
                    const li = document.createElement('li');
                    li.textContent = playlist.name;
                    li.onclick = async () => {
                        if (!playlist.tracks.includes(trackId)) {
                            const tracks = [...playlist.tracks, trackId];
                            await updatePlaylistInFirebase(playlist.id, tracks);
                        }
                        addToPlaylistModal.classList.add('hidden');
                    };
                    modalPlaylistList.appendChild(li);
                });
                addToPlaylistModal.classList.remove('hidden');
            }
            cancelAddBtn.onclick = () => addToPlaylistModal.classList.add('hidden');

            // --- PLAYER LOGIC ---
            function loadTrack(index) {
                if (index < 0 || index >= currentPlaylist.length) return;
                currentTrackIndex = index;
                const trackId = currentPlaylist[index];
                const track = allTracks.get(trackId);
                if (!track) {
                    playNextTrack();
                    return;
                }

                audioPlayer.src = URL.createObjectURL(track.file);
                playerArt.src = track.art;
                playerTitle.textContent = track.title;
                playerArtist.textContent = track.artist;
                updateActiveTrackUI();
            }

            function playTrack() { isPlaying = true; audioPlayer.play(); playPauseBtn.innerHTML = pauseIcon; }
            function pauseTrack() { isPlaying = false; audioPlayer.pause(); playPauseBtn.innerHTML = playIcon; }
            
            playPauseBtn.onclick = () => {
                if (currentTrackIndex === -1) return;
                isPlaying ? pauseTrack() : playTrack();
            };

            prevBtn.onclick = () => {
                let prevIndex = currentTrackIndex - 1;
                if (prevIndex < 0) prevIndex = currentPlaylist.length - 1;
                loadTrack(prevIndex);
                playTrack();
            };
            
            const playNextTrack = () => {
                let nextIndex = currentTrackIndex + 1;
                if (nextIndex >= currentPlaylist.length) nextIndex = 0;
                loadTrack(nextIndex);
                playTrack();
            };
            nextBtn.onclick = playNextTrack;
            audioPlayer.onended = playNextTrack;

            audioPlayer.ontimeupdate = () => {
                if (isNaN(audioPlayer.duration)) return;
                progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
            };
            audioPlayer.onloadedmetadata = () => {
                totalTimeElement.textContent = formatTime(audioPlayer.duration);
            };
            progressBar.oninput = () => {
                if (isNaN(audioPlayer.duration)) return;
                audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
            };
            
            function updateActiveTrackUI() {
                if (currentView === 'tracklist') {
                    const items = tracklistElement.querySelectorAll('.track-item');
                    items.forEach((item, index) => {
                        item.classList.toggle('active', index === currentTrackIndex);
                    });
                }
            }

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // --- INICIA O APLICATIVO ---
            init();
        });
    </script>
</body>
</html>
