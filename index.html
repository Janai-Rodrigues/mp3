<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>Meu Player Pro</title>
    <meta name="theme-color" content="#121212"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Meu Player">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/000000/music.png">
    <link rel="icon" href="https://img.icons8.com/fluency/96/000000/music.png" type="image/png">

    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAic2hvcnRfbmFtZSI6ICJQbGF5ZXIiLA0KICAibmFtZSI6ICJNZXUgUGxheWVyIGRlIE3DunNpY2EiLA0KICAiaWNvbnMiOiBbDQogICAgew0KICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvNDgvMDAwMDAwL211c2ljLnBuZyIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjQ4eDQ4Ig0KICAgIH0sDQogICAgew0KICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvOTYvMDAwMDAwL211c2ljLnBuZyIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjk2eDk2Ig0KICAgIH0NCiAgXSwNCiAgInN0YXJ0X3VybCI6ICIuIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsDQogICJ0aGVtZV9jb2xvciI6ICIjMTIxMjEyIiwNCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiINCn0=">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    
    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --primary-color: #1DB954; --background-color: #121212; --surface-color: #1e1e1e;
            --text-color: #ffffff; --text-secondary-color: #b3b3b3; --player-bar-height: 90px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--background-color);
            color: var(--text-color); display: flex; flex-direction: column; user-select: none;
        }
        .main-view {
            flex-grow: 1; overflow-y: auto;
            padding: 20px 20px calc(var(--player-bar-height) + 20px) 20px;
        }
        .hidden { display: none !important; }
        
        /* Estilos Gerais */
        .section-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .btn-primary {
            padding: 10px 20px; background-color: var(--primary-color); color: var(--text-color);
            border: none; border-radius: 50px; cursor: pointer; font-weight: 500;
            font-size: 14px; transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.95); }

        /* Tela de Carregamento/Setup */
        #setup-view {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center;
        }
        #setup-view p { color: var(--text-secondary-color); margin-bottom: 30px; max-width: 300px; }

        /* Navegação Principal (Abas) */
        #main-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--surface-color); }
        .nav-tab { padding: 10px 0; cursor: pointer; color: var(--text-secondary-color); font-weight: 500; }
        .nav-tab.active { color: var(--text-color); border-bottom: 2px solid var(--primary-color); }

        /* Grade de Álbuns e Playlists */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px;
        }
        .card {
            cursor: pointer; background-color: var(--surface-color); padding: 15px;
            border-radius: 10px; transition: background-color 0.2s;
        }
        .card:hover { background-color: #282828; }
        .card-art {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 5px; object-fit: cover;
            background-color: #333; margin-bottom: 10px; display: flex; justify-content: center;
            align-items: center; font-size: 48px;
        }
        .card-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-subtitle { font-size: 14px; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Lista de Músicas */
        #tracklist-header { display: flex; align-items: center; margin-bottom: 20px; }
        #back-btn { background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; margin-right: 15px; }
        #header-art { width: 50px; height: 50px; border-radius: 5px; margin-right: 15px; }
        #header-title { font-size: 18px; font-weight: 700; }
        
        #tracklist { list-style: none; }
        .track-item { display: flex; align-items: center; padding: 10px 5px; border-radius: 5px; cursor: pointer; position: relative; }
        .track-item:hover { background-color: #282828; }
        .track-item.active .track-title { color: var(--primary-color); }
        .track-info { flex-grow: 1; }
        .track-title { font-weight: 500; }
        .track-artist { font-size: 12px; color: var(--text-secondary-color); }
        .options-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: 20px; padding: 5px; }

        /* Player Bar */
        #player-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-bar-height);
            background-color: #181818; border-top: 1px solid #282828; padding: 10px 20px;
            display: flex; align-items: center; gap: 15px;
        }
        #player-art { width: 50px; height: 50px; border-radius: 5px; }
        #player-info { flex-grow: 1; overflow: hidden; }
        #player-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-artist { font-size: 12px; color: var(--text-secondary-color); }
        #player-controls-center { display: flex; flex-direction: column; align-items: center; }
        #player-buttons { display: flex; align-items: center; }
        .control-btn { background: none; border: none; color: var(--text-color); font-size: 22px; cursor: pointer; margin: 0 10px; }
        #play-pause-btn { font-size: 40px; }
        #progress-container { display: flex; align-items: center; gap: 8px; width: 100%; max-width: 400px; }
        #progress-bar { width: 100%; height: 4px; background: #535353; border-radius: 2px; -webkit-appearance: none; appearance: none; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-color); border-radius: 50%; }
        .time-label { font-size: 12px; color: var(--text-secondary-color); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-color); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #535353; background: #333; color: var(--text-color); margin-bottom: 15px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>

    <audio id="audio-player"></audio>

    <div id="setup-view" class="main-view">
        <p id="setup-message">Conectando ao servidor...</p>
        <button id="setup-btn" class="btn-primary hidden">Selecionar Pasta de Músicas</button>
    </div>

    <div id="library-view" class="main-view hidden">
        <nav id="main-nav">
            <span class="nav-tab active" data-view="albums-view">Álbuns</span>
            <span class="nav-tab" data-view="playlists-view">Playlists</span>
        </nav>
        
        <div id="albums-view">
            <div id="album-grid" class="grid-container"></div>
        </div>
        
        <div id="playlists-view" class="hidden">
            <button id="new-playlist-btn" class="btn-primary" style="margin-bottom: 20px;">+ Nova Playlist</button>
            <div id="playlist-grid" class="grid-container"></div>
        </div>
    </div>

    <div id="tracklist-view" class="main-view hidden">
        <div id="tracklist-header">
            <button id="back-btn">&lt;</button>
            <img id="header-art" src="https://placehold.co/100x100/333/333?text=." alt="Capa">
            <div>
                <div id="header-title">Título</div>
            </div>
        </div>
        <ul id="tracklist"></ul>
    </div>

    <div id="player-bar" class="hidden">
        <img id="player-art" src="https://placehold.co/100x100/333/333?text=.">
        <div id="player-info">
            <div id="player-title">Nenhuma música</div>
            <div id="player-artist">tocando</div>
        </div>
        <div id="player-controls-center">
            <div id="player-buttons">
                <button class="control-btn" id="prev-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="control-btn" id="play-pause-btn">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="control-btn" id="next-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"/></svg>
                </button>
            </div>
            <div id="progress-container">
                <span id="current-time" class="time-label">0:00</span>
                <input type="range" id="progress-bar" value="0" step="1">
                <span id="total-time" class="time-label">0:00</span>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="playlist-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Nova Playlist</h3>
            <input type="text" id="playlist-name-input" placeholder="Nome da Playlist">
            <div class="modal-actions">
                <button id="cancel-playlist-btn">Cancelar</button>
                <button id="create-playlist-btn" class="btn-primary">Criar</button>
            </div>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="modal-overlay hidden">
         <div class="modal-content">
            <h3>Adicionar à Playlist</h3>
            <ul id="modal-playlist-list" style="list-style:none; margin-bottom: 20px;"></ul>
            <div class="modal-actions">
                <button id="cancel-add-btn">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyCdIsMkDsxDUy4FD2TcZ4IiGnB2mpj6Tb8",
                authDomain: "mp3musica-ff3e3.firebaseapp.com",
                projectId: "mp3musica-ff3e3",
                storageBucket: "mp3musica-ff3e3.firebasestorage.app",
                messagingSenderId: "555438657869",
                appId: "1:555438657869:web:b40f7c0509311bf8642704"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let userId = null;
            let userPlaylists = [];

            // --- ELEMENTOS DA UI ---
            const setupView = document.getElementById('setup-view');
            const libraryView = document.getElementById('library-view');
            const tracklistView = document.getElementById('tracklist-view');
            const playerBar = document.getElementById('player-bar');
            // ... (todos os outros getElementById)

            // --- ESTADO DO APP ---
            let allTracks = new Map(); // Armazena todas as músicas por um ID único
            let albums = new Map();
            let currentPlaylist = [];
            let currentTrackIndex = -1;
            let isPlaying = false;

            // --- INICIALIZAÇÃO DO APP ---
            async function init() {
                try {
                    await auth.signInAnonymously();
                    userId = auth.currentUser.uid;
                    await loadPlaylistsFromFirebase();
                    
                    const dirHandle = await getDirectoryHandleFromDB();
                    if (dirHandle) {
                        setupView.querySelector('p').textContent = 'Verificando permissão da pasta...';
                        if (await verifyPermission(dirHandle)) {
                            await scanDirectory(dirHandle);
                            renderAll();
                            showView('library');
                        } else {
                            throw new Error('Permissão negada.');
                        }
                    } else {
                         showSetupButton('Selecione sua pasta de músicas para começar.');
                    }
                } catch (error) {
                    console.error("Erro na inicialização:", error);
                    showSetupButton('Clique para selecionar sua pasta de músicas.');
                }
            }
            
            function showSetupButton(message) {
                const p = setupView.querySelector('p');
                const btn = setupView.querySelector('button');
                p.textContent = message;
                btn.classList.remove('hidden');
                btn.onclick = selectAndScanDirectory;
            }
            
            async function selectAndScanDirectory() {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    await saveDirectoryHandleToDB(dirHandle);
                    setupView.querySelector('p').textContent = 'Escaneando suas músicas...';
                    await scanDirectory(dirHandle);
                    renderAll();
                    showView('library');
                } catch (err) {
                    console.error("Erro ao selecionar pasta:", err);
                    alert("Você precisa dar permissão à pasta para o app funcionar.");
                }
            }

            // --- LÓGICA DE ARQUIVOS E INDEXEDDB ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('MusicPlayerDB', 1);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        db.createObjectStore('fileStore');
                    };
                    request.onsuccess = event => resolve(event.target.result);
                    request.onerror = event => reject(event.target.error);
                });
            }

            async function saveDirectoryHandleToDB(dirHandle) {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('fileStore', 'readwrite');
                    tx.objectStore('fileStore').put(dirHandle, 'dirHandle');
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async function getDirectoryHandleFromDB() {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('fileStore', 'readonly');
                    const request = tx.objectStore('fileStore').get('dirHandle');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async function verifyPermission(dirHandle) {
                const options = { mode: 'read' };
                if (await dirHandle.queryPermission(options) === 'granted') return true;
                if (await dirHandle.requestPermission(options) === 'granted') return true;
                return false;
            }

            async function scanDirectory(dirHandle) {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.match(/\.(mp3|m4a|flac|wav)$/i)) {
                        const file = await entry.getFile();
                        await processFile(file);
                    } else if (entry.kind === 'directory') {
                        await scanDirectory(entry);
                    }
                }
            }
            
            function generateTrackId(tags, file) {
                const key = `${tags.title}-${tags.artist}-${tags.album}-${file.size}`;
                // Simple hash function
                let hash = 0;
                for (let i = 0; i < key.length; i++) {
                    const char = key.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; 
                }
                return 'track_' + Math.abs(hash);
            }

            function processFile(file) {
                return new Promise((resolve) => {
                    window.jsmediatags.read(file, {
                        onSuccess: function(tag) {
                            const tags = tag.tags;
                            const trackId = generateTrackId(tags, file);
                            
                            let imageSrc = 'https://placehold.co/300x300/333/FFFFFF?text=?';
                            if (tags.picture) {
                                const { data, format } = tags.picture;
                                let base64String = "";
                                for (let i = 0; i < data.length; i++) {
                                    base64String += String.fromCharCode(data[i]);
                                }
                                imageSrc = `data:${format};base64,${window.btoa(base64String)}`;
                            }
                            
                            const trackData = {
                                id: trackId,
                                title: tags.title || file.name.replace(/\.[^/.]+$/, ""),
                                artist: tags.artist || 'Artista Desconhecido',
                                album: tags.album || 'Álbum Desconhecido',
                                art: imageSrc,
                                file: file
                            };
                            allTracks.set(trackId, trackData);

                            const albumName = trackData.album;
                            if (!albums.has(albumName)) {
                                albums.set(albumName, { artist: trackData.artist, art: trackData.art, tracks: [] });
                            }
                            albums.get(albumName).tracks.push(trackId);
                            resolve();
                        },
                        onError: function(error) {
                            console.log('Erro ao ler tags:', file.name, error);
                            resolve();
                        }
                    });
                });
            }

            // --- LÓGICA DO FIREBASE ---
            async function loadPlaylistsFromFirebase() {
                const snapshot = await db.collection('users').doc(userId).collection('playlists').get();
                userPlaylists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            async function savePlaylistToFirebase(name, tracks = []) {
                const playlistRef = db.collection('users').doc(userId).collection('playlists').doc();
                const newPlaylist = { id: playlistRef.id, name, tracks };
                await playlistRef.set({ name, tracks });
                userPlaylists.push(newPlaylist);
                return newPlaylist;
            }
            
            async function updatePlaylistInFirebase(playlistId, tracks) {
                 await db.collection('users').doc(userId).collection('playlists').doc(playlistId).update({ tracks });
                 const playlist = userPlaylists.find(p => p.id === playlistId);
                 if(playlist) playlist.tracks = tracks;
            }

            // --- RENDERIZAÇÃO E UI ---
            function showView(viewName) {
                document.querySelectorAll('.main-view').forEach(v => v.classList.add('hidden'));
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
                playerBar.classList.remove('hidden');
            }
            
            function renderAll() {
                renderAlbums();
                renderPlaylists();
            }
            
            // ... (Funções de renderização, player, modais, etc. adaptadas para usar track IDs)
            // Esta seção seria muito longa, mas a lógica principal é:
            // - As listas (álbuns, playlists) armazenam IDs das músicas.
            // - Para obter os detalhes de uma música, usa-se `allTracks.get(trackId)`.
            // - Ao tocar uma música, `currentPlaylist` se torna uma lista de IDs.
            // - O `loadTrack` usa o índice para pegar o ID da `currentPlaylist` e depois os dados de `allTracks`.


            // --- INICIA O APLICATIVO ---
            init();
        });
    </script>
</body>
</html>
